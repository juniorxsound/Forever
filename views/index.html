<!DOCTYPE html>
<html>
<head>

	<title>
		Forever - Alogirithmic Composition
	</title>

	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

	<!--Scoket.io-->
	<script src="js/lib/socket.io-1.4.5.js"></script>

	<!-- P5.js -->
	<script src="js/lib/p5.min.js"></script>

	<!-- Tone.js -->
	<script src="js/lib/p5.sound.min.js"></script>

	<!--Client Side Global Variables=-->
	<script src="js/src/global.js"></script>

	<!--Client Side JS Utilities-->
	<script src="js/src/util.js"></script>

	<!-- Canvas and p5.js Utilities -->
	<script type="js/src/canvas.js"></script>

	<!-- Mapbox maps -->
    <script src='js/lib/mapbox-gl.js'></script>
    <link href='js/lib/mapbox-gl.css' rel='stylesheet' />

    <!-- Marcetor -->
    <script src="js/lib/sphericalmercator.js"></script>

	<!--Client Side CSS-->
	<link rel="stylesheet" href="css/client.css">

	<!-- Dat Gui for debugging -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>

</head>
<body>
<div id="interfaceDebug">
<h1>Forever - Social composition</h1>
<h2>Users</h2>
<div id="usr"></div>
<div id="location"></div>
<div id="error"></div>
</div>
<div id="map" class="map mapboxgl-map"></div>
<script>

var merc = new SphericalMercator({
    size: 512
});

		// DatGui Stuff
		window.onload = function(){

		  guiParams = new initGuiParams();

		  gui = new dat.GUI();

		  var mapping = gui.addFolder('Mapping');

		  mapping.add(guiParams, 'Xscaler', 500, 2000);

		  mapping.add(guiParams, 'Yscaler', 500, 2000);

		  var playback = gui.addFolder('Playback');

		  playback.add(guiParams, 'playSpeed', 0, 3);

		}
		// Mapbox Setup
		initMap();

		bBox = mapboxmap.getBounds();

	//Decale a new socket connection
	socket = io();

	//Once your connected log it
 	socket.on('connect', function(){

 		introduction(socket, 'player');

  	});

	//Wait for a new user from the server save it to a local server
	socket.on('user', function(count){

		userCounter(count, 'usr');

	});

	//When the server sends everybody's data back
	socket.on('serverGeoData', function(geodata){

		//Clean the array anytime the server sends over data
		canvasLocations = [];

		mapboxusers.features = [];

		//Log the data for debugging
		// console.log(geodata);

		//Assign this data globally
		serverGeo = geodata;

		//Dont start the transport before data has arrived!
		if(serverGeo != 0 && start === false){

			setTimeout(function(){

				start = true;

			}, 1000);

		}

		//Latitude is Y
		//Longtitude is X

		//Iterate over the amount of clients and map the values to canvas
		for(var i = 0; i < Object.keys(geodata).length; i++){

			var latlong = serverGeo[Object.keys(serverGeo)[i]];

			//Get the bounding box
			// var bounding = [bBox._sw.lat, bBox._ne.lat]

			// var projection = merc.xyz();

			// console.log(projection);

			// var mappedY = projection[0];
			// var mappedX = projection[1];

			var mappedY = map(latlong[0], 40.63878188068054, 
40.84661576176842, height, 0);
			var mappedX = map(latlong[1], -74.16299102783208, -73.79700897216797, 0, width);

			canvasLocations.push([mappedX, mappedY]);

			var userGeoJson = {
				"type": "Feature",
				"geometry": {
			        "type": "Point",
			        "coordinates": [latlong[1], latlong[0]]
      			}
			}

			mapboxusers.features.push(userGeoJson);



		}




	});



	function preload(){};

	function setup(){

		//Setting up a canvas
		createCanvas(windowWidth, windowHeight);

		//Setup envelope
		env = new p5.Env();
  		env.setADSR(0.5, 0.2, 0.1, 0.5);

		//Setting up a test oscilator
		osc = new p5.Oscillator();
		freq = midiToFreq(pentatonicMin[0]);
		osc.setType('sine');
		osc.freq(440);
		osc.amp(env);
		osc.start();

	};



	function draw(){
		clear();

		//Draw a white background
		// background(0,0,0,1);

		//Don't start before the server sends off gps data
		if(start == true){
			//Transport courser increment
			transportLine = transportLine + guiParams.playSpeed;
		}

		//Courser
		stroke(255, 255, 255);
		line(transportLine, height, transportLine, 0);

		//Make it repeat and count cycles
		if(parseInt(transportLine) == width){

			transportLine = 0;

			cycleCounter++;

		}

		//Iterate over the array that stores users pixel postions
		for(var i = 0; i < canvasLocations.length; i++){

			var locations = canvasLocations[i];

			//Draw a rect for each user
			rect(locations[0], locations[1], 5, 5);

			//If the courser reaches a user trigger the synth
			if(parseInt(transportLine) == parseInt(locations[0])){

				playNote();

			}

		}

	};

	//Resize Canvas to Fit the Screen
	window.onresize = function() {

	  var w = window.innerWidth;

	  var h = window.innerHeight

	  resizeCanvas(w,h);

	  bBox = mapboxmap.getBounds();

	}

	//Never give up pushing the data!
  	setInterval(function(){

  		//1st Argument is wheter to appand the value to the DOM second is the div
	  	var geodata = getGeoPosition(false, 'location');

  	}, 1000);
</script>
</body>
</html>
